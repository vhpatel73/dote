{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<header style="margin-bottom: 2rem;">
    <h1>Value <span class="gradient-text">Dashboard</span></h1>
    <p class="stat-label" style="font-size: 0.7rem; margin-top: -0.5rem;">AI initiatives At A Glance and realized
        values.</p>
</header>

<div class="stats-grid">
    <div class="stat-card glass clickable-card" onclick="location.href='{% url 'initiative_list' %}';">
        <div class="stat-header">
            <div class="stat-icon-box" style="background: rgba(66, 133, 244, 0.1); color: #4285F4;">
                <i class="fas fa-vault"></i>
            </div>
            <div class="stat-label">Total Initiatives</div>
        </div>
        <div class="stat-value">{{ total_initiatives }}</div>
    </div>
    <div class="stat-card glass clickable-card" onclick="location.href='{% url 'initiative_list' %}?q=Live';">
        <div class="stat-header">
            <div class="stat-icon-box" style="background: rgba(52, 168, 83, 0.1); color: #34A853;">
                <i class="fas fa-rocket"></i>
            </div>
            <div class="stat-label">Live Capabilities</div>
        </div>
        <div class="stat-value">{{ live_systems }}</div>
    </div>
    <div class="stat-card glass clickable-card"
        onclick="location.href='{% url 'benefit_analysis' %}?tab=initiative&sort=prod';">
        <div class="stat-header">
            <div class="stat-icon-box" style="background: rgba(251, 188, 5, 0.1); color: #FBBC05;">
                <i class="fas fa-stopwatch"></i>
            </div>
            <div class="stat-label">Productivity Gain</div>
        </div>
        <div class="stat-value">${{ total_productivity|floatformat:2|intcomma }}</div>
        <span class="text-tiny">Since Inception</span>
    </div>
    <div class="stat-card glass clickable-card"
        onclick="location.href='{% url 'benefit_analysis' %}?tab=initiative&sort=rev';">
        <div class="stat-header">
            <div class="stat-icon-box" style="background: rgba(234, 67, 53, 0.1); color: #EA4335;">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="stat-label">Revenue Impact ($)</div>
        </div>
        <div class="stat-value">${{ total_revenue|floatformat:2|intcomma }}</div>
        <span class="text-tiny">Since Inception</span>
    </div>
    <div class="stat-card glass clickable-card" onclick="location.href='{% url 'benefit_analysis' %}?tab=month';">
        <div class="stat-header">
            <div class="stat-icon-box" style="background: rgba(143, 0, 255, 0.1); color: #8F00FF;">
                <i class="fas fa-signal"></i>
            </div>
            <div class="stat-label">Total Impact</div>
        </div>
        <div class="stat-value">${{ total_overall|floatformat:2|intcomma }}</div>
        <div class="text-tiny">Since Inception</div>
    </div>
</div>

<style>
    .stat-card {
        padding: 1.25rem !important;
        text-align: left !important;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .stat-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .stat-icon-box {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        flex-shrink: 0;
    }

    .stat-value {
        font-size: 1.5rem !important;
        margin-top: 0.25rem;
        background: var(--accent-glow);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
        width: 100%;
    }

    .stat-label {
        font-size: 0.7rem !important;
        font-weight: 700;
        white-space: nowrap;
    }

    .clickable-card {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }

    .clickable-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-color) !important;
    }

    /* Tab styles */
    .tab-container {
        margin-top: 2rem;
        margin-bottom: 3rem;
    }

    .tab-nav {
        display: flex;
        gap: 0.5rem;
        margin: 0 auto 1.5rem auto;
        padding: 4px;
        background: rgba(255, 255, 255, 0.3);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        width: fit-content;
    }

    .tab-btn {
        background: transparent;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--text-secondary);
    }

    .tab-btn.active {
        background: white;
        color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .tab-pane {
        display: none;
    }

    .tab-pane.active {
        display: flex;
        gap: 2rem;
        align-items: center;
    }

    .dashboard-table-container {
        flex: 1.2;
    }

    .dashboard-chart-container {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .analytic-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }

    .analytic-table th {
        text-align: left;
        padding: 0.75rem 1rem;
        color: var(--text-secondary);
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid var(--border-color);
    }

    .analytic-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .analytic-table tr:last-child td {
        border-bottom: none;
    }

    @media (max-width: 992px) {
        .tab-pane.active {
            flex-direction: column-reverse;
        }
    }

    .drill-down-link {
        color: var(--text-primary);
        text-decoration: none;
        transition: color 0.2s;
        cursor: pointer;
    }

    .drill-down-link:hover {
        color: var(--primary-color);
        text-decoration: underline;
    }
</style>

<div class="card glass tab-container">
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('func')">Functional View</button>
        <button class="tab-btn" onclick="switchTab('status')">Status View</button>
        <button class="tab-btn" onclick="switchTab('tech')">Technology View</button>
    </div>

    <!-- Functional Pane -->
    <div id="pane-func" class="tab-pane active">
        <div class="dashboard-table-container">
            <table class="analytic-table">
                <thead>
                    <tr>
                        <th>Department</th>
                        <th style="text-align: center;">Count</th>
                        <th style="text-align: right;">Prod. Gain ($)</th>
                        <th style="text-align: right;">Rev. Impact ($)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in dept_stats %}
                    <tr>
                        <td style="font-weight: 700;">
                            <a href="{% url 'initiative_list' %}?q={{ item.department|urlencode }}"
                                class="drill-down-link">
                                {{ item.department }}
                            </a>
                        </td>
                        <td style="text-align: center;"><span class="badge"
                                style="background: rgba(0, 122, 255, 0.1); color: var(--primary-color);">{{item.count}}</span>
                        </td>
                        <td style="text-align: right; color: var(--primary-color); font-weight: 600;">
                            ${{item.prod_gain|floatformat:0|intcomma}}</td>
                        <td style="text-align: right; color: #34A853; font-weight: 600;">
                            ${{item.rev_impact|floatformat:0|intcomma}}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="dashboard-chart-container">
            <div style="height: 300px; width: 100%;">
                <canvas id="deptChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Status Pane -->
    <div id="pane-status" class="tab-pane">
        <div class="dashboard-table-container">
            <table class="analytic-table">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th style="text-align: center;">Count</th>
                        <th style="text-align: right;">Prod. Gain ($)</th>
                        <th style="text-align: right;">Rev. Impact ($)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in status_stats %}
                    <tr>
                        <td style="font-weight: 700;">
                            <a href="{% url 'initiative_list' %}?q={{ item.status|urlencode }}" class="drill-down-link">
                                {{ item.status }}
                            </a>
                        </td>
                        <td style="text-align: center;"><span class="badge"
                                style="background: rgba(0, 122, 255, 0.1); color: var(--primary-color);">{{item.count}}</span>
                        </td>
                        <td style="text-align: right; color: var(--primary-color); font-weight: 600;">
                            ${{item.prod_gain|floatformat:0|intcomma}}</td>
                        <td style="text-align: right; color: #34A853; font-weight: 600;">
                            ${{item.rev_impact|floatformat:0|intcomma}}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="dashboard-chart-container">
            <div style="height: 300px; width: 100%;">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Tech Pane -->
    <div id="pane-tech" class="tab-pane">
        <div class="dashboard-table-container">
            <table class="analytic-table">
                <thead>
                    <tr>
                        <th>Technology</th>
                        <th style="text-align: center;">Count</th>
                        <th style="text-align: right;">Prod. Gain ($)</th>
                        <th style="text-align: right;">Rev. Impact ($)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in tech_stats %}
                    <tr>
                        <td style="font-weight: 700;">
                            <a href="{% url 'initiative_list' %}?q={{ item.technology|urlencode }}"
                                class="drill-down-link">
                                {{ item.technology }}
                            </a>
                        </td>
                        <td style="text-align: center;"><span class="badge"
                                style="background: rgba(0, 122, 255, 0.1); color: var(--primary-color);">{{item.count}}</span>
                        </td>
                        <td style="text-align: right; color: var(--primary-color); font-weight: 600;">
                            ${{item.prod_gain|floatformat:0|intcomma}}</td>
                        <td style="text-align: right; color: #34A853; font-weight: 600;">
                            ${{item.rev_impact|floatformat:0|intcomma}}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="dashboard-chart-container">
            <div style="height: 300px; width: 100%;">
                <canvas id="techChart"></canvas>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
{{ dept_data|json_script:"dept-data" }}
{{ status_data|json_script:"status-data" }}
{{ tech_data|json_script:"tech-data" }}

<script>
    function switchTab(type) {
        // Toggle buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.toLowerCase().includes(type)) btn.classList.add('active');
        });

        // Toggle panes
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('active');
        });
        document.getElementById('pane-' + type).classList.add('active');
    }

    // Chart Color Palette
    const COLORS = [
        '#4285F4', // Google Blue
        '#34A853', // Google Green
        '#FBBC05', // Google Yellow
        '#EA4335', // Google Red
        '#8F00FF', // Purple
        '#00C7BE', // Teal
        '#FF9500', // Orange
        '#5856D6', // Indigo
        '#AF52DE', // Pink
        '#5AC8FA'  // Sky
    ];

    function createChart(id, labels, data) {
        const ctx = document.getElementById(id);
        if (!ctx) return;

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: COLORS,
                    borderWidth: 0,
                    hoverOffset: 15
                }]
            },
            options: {
                cutout: '70%',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: { family: 'Inter', size: 12 }
                        }
                    }
                }
            }
        });
    }

    // Initialize charts if data exists
    {% if total_initiatives > 0 %}
    (function () {
        function getJsonData(id) {
            var el = document.getElementById(id);
            if (!el) return null;
            try { return JSON.parse(el.textContent); }
            catch (e) { return null; }
        }

        var deptData = getJsonData('dept-data');
        var statusData = getJsonData('status-data');
        var techData = getJsonData('tech-data');

        if (deptData) createChart('deptChart', deptData.labels, deptData.counts);
        if (statusData) createChart('statusChart', statusData.labels, statusData.counts);
        if (techData) createChart('techChart', techData.labels, techData.counts);
    })();
    {% endif %}

    function showBreakdown(dept) {
        var url = "{% url 'initiative_list' %}";
        window.location.href = url + "?department=" + encodeURIComponent(dept);
    }
</script>
{% endblock %}