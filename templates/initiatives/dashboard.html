{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<header style="margin-bottom: 2rem;">
    <h2>Value <span class="gradient-text">Dashboard</span></h2>
    <p class="stat-label" style="font-size: 0.7rem; margin-top: -0.5rem;">AI initiatives At A Glance and realized
        values.</p>
</header>

<div class="stats-grid">
    <div class="stat-card glass clickable-card" onclick="location.href='{% url 'initiative_list' %}';">
        <div class="stat-header">
            <div class="stat-icon-box" style="background: rgba(66, 133, 244, 0.1); color: #4285F4;">
                <i class="fas fa-vault"></i>
            </div>
            <div class="stat-text">
                <div class="stat-label">Total Initiatives</div>
            </div>
        </div>
        <div class="stat-value">{{ total_initiatives }}</div>
    </div>
    <div class="stat-card glass clickable-card" onclick="location.href='{% url 'initiative_list' %}?q=Live';">
        <div class="stat-header">
            <div class="stat-icon-box" style="background: rgba(52, 168, 83, 0.1); color: #34A853;">
                <i class="fas fa-rocket"></i>
            </div>
            <div class="stat-text">
                <div class="stat-label">Live Capabilities</div>
            </div>
        </div>
        <div class="stat-value">{{ live_systems }}</div>
    </div>
    <div class="stat-card glass clickable-card"
        onclick="location.href='{% url 'benefit_analysis' %}?tab=initiative&sort=prod';">
        <div class="stat-header">
            <div class="stat-icon-box" style="background: rgba(251, 188, 5, 0.1); color: #FBBC05;">
                <i class="fas fa-stopwatch"></i>
            </div>
            <div class="stat-text">
                <div class="stat-label">Productivity Gain</div>
                <span class="text-tiny">Since Inception</span>
            </div>
        </div>
        <div class="stat-value">${{ total_productivity|floatformat:2|intcomma }}</div>
    </div>
    <div class="stat-card glass clickable-card"
        onclick="location.href='{% url 'benefit_analysis' %}?tab=initiative&sort=rev';">
        <div class="stat-header">
            <div class="stat-icon-box" style="background: rgba(234, 67, 53, 0.1); color: #EA4335;">
                <i class="fas fa-file-invoice"></i>
            </div>
            <div class="stat-text">
                <div class="stat-label">Revenue Impact ($)</div>
                <span class="text-tiny">Since Inception</span>
            </div>
        </div>
        <div class="stat-value">${{ total_revenue|floatformat:2|intcomma }}</div>
    </div>
    <div class="stat-card glass clickable-card total-impact-card"
        onclick="location.href='{% url 'benefit_analysis' %}?tab=month';">
        <div class="stat-header">
            <div class="stat-icon-box" style="background: rgba(143, 0, 255, 0.1); color: #8F00FF;">
                <i class="fas fa-signal"></i>
            </div>
            <div class="stat-text">
                <div class="stat-label">Total Impact</div>
                <span class="text-tiny">Since Inception</span>
            </div>
        </div>
        <div class="stat-value">${{ total_overall|floatformat:2|intcomma }}</div>
    </div>
</div>

<style>
    .stat-card {
        padding: 1.25rem !important;
        text-align: left !important;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .stat-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .stat-text {
        display: flex;
        flex-direction: column;
        gap: 0.1rem;
        align-items: flex-start;
        text-align: left;
    }

    .stat-icon-box {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        flex-shrink: 0;
    }

    .stat-value {
        font-size: 1.5rem !important;
        margin-top: 0.25rem;
        background: var(--accent-glow);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
        width: 100%;
    }

    .stat-label {
        font-size: 0.7rem !important;
        font-weight: 700;
        white-space: normal;
        line-height: 1.2;
    }

    .clickable-card {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }

    .clickable-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-color) !important;
    }

    /* Tab styles */
    .tab-container {
        margin-top: 2rem;
        margin-bottom: 3rem;
    }

    .tab-nav {
        display: flex;
        gap: 0.5rem;
        margin: 0 auto 1.5rem auto;
        padding: 4px;
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        width: fit-content;
        max-width: 100%;
        flex-wrap: wrap;
        justify-content: center;
    }

    .tab-btn {
        background: transparent;
        border: none;
        padding: 0.6rem 1rem;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--text-secondary);
        white-space: nowrap;
    }

    .tab-btn.active {
        background: white;
        color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .tab-pane {
        display: none;
    }

    .tab-pane.active {
        display: flex;
        gap: 2rem;
        align-items: flex-start;
    }

    .dashboard-table-container {
        flex: 1.2;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        align-self: center;
    }

    .dashboard-chart-container {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        align-self: flex-start;
    }

    .analytic-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }

    .analytic-table th {
        text-align: left;
        padding: 0.75rem 1rem;
        color: var(--text-secondary);
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid var(--border-color);
    }

    .analytic-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .analytic-table tr:last-child td {
        border-bottom: none;
    }

    @media (max-width: 992px) {
        .tab-pane.active {
            flex-direction: column-reverse;
        }
    }

    @media (max-width: 480px) {
        .tab-btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.7rem;
        }

        .stat-value {
            font-size: 1.25rem !important;
        }
    }

    .drill-down-link {
        color: var(--text-primary);
        text-decoration: none;
        transition: color 0.2s;
        cursor: pointer;
    }

    .drill-down-link:hover {
        color: var(--primary-color);
        text-decoration: underline;
    }

    .color-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
        flex-shrink: 0;
    }
</style>

<div class="card glass tab-container">
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('func')">Functional View</button>
        <button class="tab-btn" onclick="switchTab('status')">Status View</button>
        <button class="tab-btn" onclick="switchTab('tech')">Technology View</button>
    </div>

    <!-- Functional Pane -->
    <div id="pane-func" class="tab-pane active">
        {% if dept_stats %}
        <div class="dashboard-table-container">
            <table class="analytic-table">
                <thead>
                    <tr>
                        <th>Function</th>
                        <th style="text-align: center;">Count</th>
                        <th style="text-align: right;">Prod. Gain ($)</th>
                        <th style="text-align: right;">Rev. Impact ($)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in dept_stats %}
                    <tr>
                        <td style="font-weight: 700;">
                            <div style="display: flex; align-items: center;">
                                <span class="color-dot" style="background-color: {{ item.color }};"></span>
                                <a href="{% url 'initiative_list' %}?q={{ item.department|urlencode }}"
                                    class="drill-down-link">
                                    {{ item.department }}
                                </a>
                            </div>
                        </td>
                        <td style="text-align: center;"><span class="badge"
                                style="background: rgba(0, 122, 255, 0.1); color: black;">{{item.count}}</span>
                        </td>
                        <td style="text-align: right; font-weight: 500;">
                            ${{item.prod_gain|floatformat:0|intcomma}}</td>
                        <td style="text-align: right; font-weight: 500;">
                            ${{item.rev_impact|floatformat:0|intcomma}}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="dashboard-chart-container">
            <div style="height: 300px; width: 100%;">
                <canvas id="deptChart"></canvas>
            </div>
        </div>
        {% else %}
        <div
            style="width: 100%; text-align: center; padding: 4rem 2rem; border-radius: 16px; background: var(--bg-secondary); color: var(--text-secondary); border: 1px dashed rgba(52, 168, 83, 0.2);">
            <svg width="150" height="80" viewBox="0 0 150 80"
                style="margin-bottom: 1rem; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">
                <!-- Light green line artwork -->
                <path d="M10 60 Q 40 10, 75 40 T 140 20" opacity="0.6" stroke-dasharray="4 4" />
                <path d="M10 70 Q 50 20, 85 50 T 140 30" stroke-width="3" />
                <circle cx="140" cy="30" r="5" fill="currentColor" />
            </svg>
            <h3 style="margin-bottom: 0.5rem; font-weight: 600;">Nothing to display</h3>
            <p style="opacity: 0.8; font-size: 0.9rem;">Add an initiative and start tracking data to populate this
                functional view.</p>
        </div>
        {% endif %}
    </div>

    <!-- Status Pane -->
    <div id="pane-status" class="tab-pane">
        {% if status_stats %}
        <div class="dashboard-table-container">
            <table class="analytic-table">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th style="text-align: center;">Count</th>
                        <th style="text-align: right;">Prod. Gain ($)</th>
                        <th style="text-align: right;">Rev. Impact ($)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in status_stats %}
                    <tr>
                        <td style="font-weight: 700;">
                            <div style="display: flex; align-items: center;">
                                <span class="color-dot" style="background-color: {{ item.color }};"></span>
                                <a href="{% url 'initiative_list' %}?q={{ item.status|urlencode }}"
                                    class="drill-down-link">
                                    {{ item.status }}
                                </a>
                            </div>
                        </td>
                        <td style="text-align: center;"><span class="badge"
                                style="background: rgba(0, 122, 255, 0.1); color: black;">{{item.count}}</span>
                        </td>
                        <td style="text-align: right; font-weight: 500;">
                            ${{item.prod_gain|floatformat:0|intcomma}}</td>
                        <td style="text-align: right; font-weight: 500;">
                            ${{item.rev_impact|floatformat:0|intcomma}}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="dashboard-chart-container">
            <div style="height: 300px; width: 100%;">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
        {% else %}
        <div
            style="width: 100%; text-align: center; padding: 4rem 2rem; border-radius: 16px; background: var(--bg-secondary); color: var(--text-secondary); border: 1px dashed rgba(52, 168, 83, 0.2);">
            <svg width="150" height="80" viewBox="0 0 150 80"
                style="margin-bottom: 1rem; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">
                <!-- Light green line artwork -->
                <path d="M10 60 Q 40 10, 75 40 T 140 20" opacity="0.6" stroke-dasharray="4 4" />
                <path d="M10 70 Q 50 20, 85 50 T 140 30" stroke-width="3" />
                <circle cx="140" cy="30" r="5" fill="currentColor" />
            </svg>
            <h3 style="margin-bottom: 0.5rem; font-weight: 600;">Nothing to display</h3>
            <p style="opacity: 0.8; font-size: 0.9rem;">Add an initiative and start tracking data to populate this
                status view.</p>
        </div>
        {% endif %}
    </div>

    <!-- Tech Pane -->
    <div id="pane-tech" class="tab-pane">
        {% if tech_stats %}
        <div class="dashboard-table-container">
            <table class="analytic-table">
                <thead>
                    <tr>
                        <th>Technology</th>
                        <th style="text-align: center;">Count</th>
                        <th style="text-align: right;">Prod. Gain ($)</th>
                        <th style="text-align: right;">Rev. Impact ($)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in tech_stats %}
                    <tr>
                        <td style="font-weight: 700;">
                            <div style="display: flex; align-items: center;">
                                <span class="color-dot" style="background-color: {{ item.color }};"></span>
                                <a href="{% url 'initiative_list' %}?q={{ item.technology|urlencode }}"
                                    class="drill-down-link">
                                    {{ item.technology }}
                                </a>
                            </div>
                        </td>
                        <td style="text-align: center;"><span class="badge"
                                style="background: rgba(0, 122, 255, 0.1); color: black;">{{item.count}}</span>
                        </td>
                        <td style="text-align: right; font-weight: 500;">
                            ${{item.prod_gain|floatformat:0|intcomma}}</td>
                        <td style="text-align: right; font-weight: 500;">
                            ${{item.rev_impact|floatformat:0|intcomma}}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="dashboard-chart-container">
            <div style="height: 300px; width: 100%;">
                <canvas id="techChart"></canvas>
            </div>
        </div>
        {% else %}
        <div
            style="width: 100%; text-align: center; padding: 4rem 2rem; border-radius: 16px;    background: var(--bg-secondary); color: var(--text-secondary); border: 1px dashed rgba(52, 168, 83, 0.2);">
            <svg width="150" height="80" viewBox="0 0 150 80"
                style="margin-bottom: 1rem; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">
                <!-- Light green line artwork -->
                <path d="M10 60 Q 40 10, 75 40 T 140 20" opacity="0.6" stroke-dasharray="4 4" />
                <path d="M10 70 Q 50 20, 85 50 T 140 30" stroke-width="3" />
                <circle cx="140" cy="30" r="5" fill="currentColor" />
            </svg>
            <h3 style="margin-bottom: 0.5rem; font-weight: 600;">Nothing to display</h3>
            <p style="opacity: 0.8; font-size: 0.9rem;">Add an initiative and start tracking data to populate this
                technology view.</p>
        </div>
        {% endif %}
    </div>
</div>


{% endblock %}

{% block extra_js %}
{{ dept_data|json_script:"dept-data" }}
{{ status_data|json_script:"status-data" }}
{{ tech_data|json_script:"tech-data" }}

<script>
    // Global chart storage to fix rendering issues in hidden tabs
    const charts = {};

    function switchTab(type) {
        // Toggle buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.toLowerCase().includes(type)) btn.classList.add('active');
        });

        // Toggle panes
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('active');
        });
        document.getElementById('pane-' + type).classList.add('active');

        // Force Chart.js to resize now that the container is visible
        const chartId = type === 'func' ? 'deptChart' : (type === 'status' ? 'statusChart' : 'techChart');
        if (charts[chartId]) {
            charts[chartId].resize();
        }
    }

    // Chart Color Palette
    const COLORS = [
        '#4285F4', // Google Blue
        '#34A853', // Google Green
        '#FBBC05', // Google Yellow
        '#EA4335', // Google Red
        '#8F00FF', // Purple
        '#00C7BE', // Teal
        '#FF9500', // Orange
        '#5856D6', // Indigo
        '#AF52DE', // Pink
        '#5AC8FA'  // Sky
    ];

    function createChart(id, labels, data) {
        const ctx = document.getElementById(id);
        if (!ctx) return;

        const labelsWithCounts = labels.map((label, i) => `${label} (${data[i]})`);

        charts[id] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labelsWithCounts,
                datasets: [{
                    data: data,
                    backgroundColor: COLORS,
                    borderWidth: 0,
                    hoverOffset: 15
                }]
            },
            options: {
                cutout: '65%',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'right',
                        labels: {
                            color: 'var(--text-secondary)',
                            font: {
                                size: 11,
                                family: 'ui-sans-serif, system-ui, sans-serif'
                            }
                        }
                    }
                }
            }
        });
    }

    // Initialize charts if data exists
    {% if total_initiatives > 0 %}
    (function () {
        function getJsonData(id) {
            var el = document.getElementById(id);
            if (!el) return null;
            try { return JSON.parse(el.textContent); }
            catch (e) { return null; }
        }

        var deptData = getJsonData('dept-data');
        var statusData = getJsonData('status-data');
        var techData = getJsonData('tech-data');

        if (deptData) createChart('deptChart', deptData.labels, deptData.counts);
        if (statusData) createChart('statusChart', statusData.labels, statusData.counts);
        if (techData) createChart('techChart', techData.labels, techData.counts);
    })();
    {% endif %}

    function showBreakdown(dept) {
        var url = "{% url 'initiative_list' %}";
        window.location.href = url + "?department=" + encodeURIComponent(dept);
    }
</script>
{% endblock %}